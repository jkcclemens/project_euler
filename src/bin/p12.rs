// The sequence of triangle numbers is generated by adding the natural numbers. So the 7th triangle
// number would be 1 + 2 + 3 + 4 + 5 + 6 + 7 = 28. The first ten terms would be:

// 1, 3, 6, 10, 15, 21, 28, 36, 45, 55, ...

// Let us list the factors of the first seven triangle numbers:

//  1: 1
//  3: 1,3
//  6: 1,2,3,6
// 10: 1,2,5,10
// 15: 1,3,5,15
// 21: 1,3,7,21
// 28: 1,2,4,7,14,28
// We can see that 28 is the first triangle number to have over five divisors.

// What is the value of the first triangle number to have over five hundred divisors?

extern crate project_euler;
extern crate num;

use num::{CheckedAdd, Zero, One};
use project_euler::factors::factors;

fn main() {
  let num: u64 = TriangleNumbers::default()
    .map(|x| (x, factors(x)))
    .find(|&(_, ref f)| f.len() > 500)
    .map(|(x, _)| x)
    .unwrap();
  println!("{}", num);
}

struct TriangleNumbers<T> {
  index: T,
  last: T
}

impl<T> Default for TriangleNumbers<T>
  where T: CheckedAdd + Zero + One + Clone
{
  fn default() -> Self {
    TriangleNumbers {
      index: T::zero(),
      last: T::zero()
    }
  }
}

impl<T> Iterator for TriangleNumbers<T>
  where T: CheckedAdd + Zero + One + Clone
{
  type Item = T;

  fn next(&mut self) -> Option<Self::Item> {
    let next_index = match self.index.checked_add(&T::one()) {
      Some(i) => i,
      None => return None
    };
    let res = match self.last.checked_add(&next_index) {
      Some(r) => r,
      None => return None
    };
    self.index = next_index;
    self.last = res.clone();
    Some(res)
  }
}
